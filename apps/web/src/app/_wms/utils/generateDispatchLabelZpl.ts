/**
 * Generate ZPL code for a dispatch pallet label
 *
 * Designed for 4" x 6" (100mm x 150mm) direct thermal labels on Zebra ZD421 printer.
 * Used to label physical pallets being loaded onto trucks. Includes C&C logo, QR code,
 * distributor name, batch number, order list, and a blank "PALLET ___ OF ___"
 * field for the operator to fill in by hand.
 *
 * @example
 *   generateDispatchLabelZpl({
 *     batchNumber: 'BATCH-2026-0042',
 *     distributorName: 'MMI Distribution',
 *     totalCases: 120,
 *     orderNumbers: ['SO-00145', 'SO-00146', 'PCO-0023'],
 *     dispatchedAt: new Date(),
 *     notes: 'Truck #42',
 *   });
 */

export interface DispatchLabelData {
  /** Batch number (e.g. BATCH-2026-0042) */
  batchNumber: string;
  /** Distributor / recipient name */
  distributorName: string;
  /** Total cases in the batch */
  totalCases: number;
  /** Order numbers included in the batch */
  orderNumbers: string[];
  /** Date dispatched */
  dispatchedAt: Date;
  /** Optional notes (e.g. truck number) */
  notes?: string | null;
}

/**
 * Normalize accented characters to ASCII equivalents for thermal printers
 */
const normalizeAccents = (str: string) => {
  return str
    .normalize('NFD')
    .replace(/[\u0300-\u036f]/g, '')
    .replace(/œ/g, 'oe')
    .replace(/Œ/g, 'OE')
    .replace(/æ/g, 'ae')
    .replace(/Æ/g, 'AE')
    .replace(/ß/g, 'ss');
};

/**
 * Escape special characters for ZPL
 */
const escapeZpl = (str: string) => {
  return normalizeAccents(str).replace(/\^/g, ' ').replace(/~/g, ' ');
};

/**
 * Truncate string to max length with ellipsis
 */
const truncate = (str: string, maxLen: number) => {
  if (str.length <= maxLen) return str;
  return str.slice(0, maxLen - 3) + '...';
};

/**
 * Format date as YYYY-MM-DD
 */
const formatDate = (date: Date) => {
  return new Date(date).toISOString().split('T')[0];
};

/** C&C logo as ZPL graphic (400x119 dots, fresh conversion from cc-logo-cropped.png) */
const DISPATCH_LOGO_GF = '^GFA,5950,5950,50,00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000FFFFFFFFFFFFFFFFFFFFFFFFF000000000000000000000000000000000000000000000000000000000000000000000000000FFFFFFFFFFFFFFFFFFFFFFFFF000000000000000000000000000000000000000000000000000000000000000000000000000FFFFFFFFFFFFFFFFFFFFFFFFF000000000000000000000000000000000000000000000000000000000000000000000000000FFFFFFFFFFFFFFFFFFFFFFFFF000000000000000000000000000000000000000000000000000000000000000000000000000FFFFFFFFFFFFFFFFFFFFFFFFF000000000000000000000000000000000000000000000000000000000000000000000000000FFFFFFFFFFFFFFFFFFFFFFFFF000000000000000000000000000000000000000000000000000000000000000000000000000FE0000000000000000000003F000000000000000000000000000000000000000000000000000000000000000000000000000FE0000000000000000000003F000000000000000000000000000000000000000000000000000000000000000000000000000FE0000000000000000000003F000000000000000000000000000000000000000000000000000000000000000000000000000FE0000000000000000000003F000000000000000000000000000000000000000000000000000000000000000000000000000FE0000000000000000000003F000000000000000000000000000000000000000000000000000000000000000000000000000FE0000000000000000000003F000000000001FC000000000000000000000000000000000000000000000000007E000000000FE0000000000000000000003F00000000001FFFC00003FFFFC00000001FC000001FFFFFF807FFFFFFF8000001FFC00000000FE0000000000000000000003F00000000007FFFF00003FFFFF80000001FC000001FFFFFF807FFFFFFF8000007FFF00000000FE0000000000000000000003F0000000001FFFFFC0003FFFFFC0000003FE000001FFFFFF807FFFFFFF800000FFFF80000000FE0000000000000000000003F0000000003FFFFFE0003FFFFFE0000003FE000001FFFFFF807FFFFFFF800001FFFFC0000000FE0000000000000000000003F0000000007FFFFFF0003FFFFFF0000007FE000001FFFFFF807FFFFFFF800001FFFFC0000000FE0000000000000000000003F000000000FFF0FFF8003FFFFFF8000007FF000001FFFFFF807FFFFFFF800003FC1FE0000000FE0000000000000000000003F000000001FF800FFC003F800FFC000007FF000001F80000000003F000000003F00FE0000000FE0000000000000000000003F000000003FE0003FE003F8003FC00000FFF000001F80000000003F000000003F007E0000000FE0000000000000000000003F000000007FC0001F8003F8001FC00000FFF800001F80000000003F000000003F007E0000000FE000000000003FFFF800003F000000007F80000F0003F8000FC00001FDF800001F80000000003F000000003F007E0000000FE00000000007FFFFFFF8003F00000000FF0000040003F8000FC00001F9FC00001F80000000003F000000003F00FE0000000FE0000000007FFFFFFFF8003F00000000FE0000000003F8000FC00001F8FC00001F80000000003F000000003F80FE0000000FE000000003FFFFFFFFF8003F00000001FE0000000003F8000FC00003F8FC00001F80000000003F000000003F81FC0000000FE00000000FFFFFFFFFF8003F00000001FC0000000003F8000FC00003F0FE00001F80000000003F000000001FC7FC0000000FE00000003FFFFFFFFFF8003F00000001FC0000000003F8001FC00007F07E00001F80000000003F000000001FEFF80000000FE0000000FFFFF0000FF8003F00000001F80000000003F8003FC00007F07F00001FFFFF0000003F000000000FFFF00000000FE0000001FFFC00000000003F00000001F80000000003F8007F800007E07F00001FFFFF0000003F0000000007FFE00000000FE0000007FFC000000000003F00000003F80000000003F801FF80000FE03F00001FFFFF0000003F0000000003FFC00000000FE000000FFF0000000000003F00000003F80000000003FFFFFF00000FC03F80001FFFFF0000003F0000000007FF007E00000FE000001FFC0000000000003F00000003F80000000003FFFFFE00001FC01F80001FFFFF0000003F000000000FFE007E00000FE000003FF00000000000003F00000003F80000000003FFFFFC00001FC01FC0001FFFFF0000003F000000003FFF00FE00000FE000007FC00000000000003F00000003F80000000003FFFFF800001F801FC0001F80000000003F000000007FFF80FE00000FE00000FF800000000000003F00000001F80000000003FFFFE000003FFFFFC0001F80000000003F00000000FFBFC0FC00000FE00001FF000003FFFE00003F00000001FC0000000003FFFFF000003FFFFFE0001F80000000003F00000000FE1FE1FC00000FE00003FE00007FFFFFF8003F00000001FC0000000003F807F000007FFFFFE0001F80000000003F00000001FC0FF1F800000FE00003FC0003FFFFFFF8003F00000001FC0000000003F803F800007FFFFFF0001F80000000003F00000003F807FBF800000FE00007F8000FFFFFFFF8003F00000000FE0000000003F803F800007FFFFFF0001F80000000003F00000003F807FFF000000FE0000FF0003FFFFFFFF8003F00000000FF0000000003F801FC0000FFFFFFF0001F80000000003F00000003F003FFF000000FE0000FE0007FFFFFFFF8003F000000007F8000040003F801FC0000FFFFFFF8001F80000000003F00000003F001FFE000000FE0001FC000FFFFFFFFF8003F000000007F80000F0003F800FE0000FC0003F8001F80000000003F00000007F000FFC000000FE0001FC001FFE0000010003F000000003FE0001FC003F800FF0001FC0001F8001F80000000003F00000007F0007FC000000FE0003F8003FF00000000003F000000001FF0007FE003F8007F0001FC0001FC001F80000000003F00000003F8007FC000000FE0003F8007FC00000000003F000000000FFE01FFC003F8003F8003F80001FC001F80000000003F00000003FC01FFE000000FE0007F000FF800000000003F000000000FFFFFFF8003F8003F8003F80000FE001F80000000003F00000003FF07FFF000000FE0007F001FE000000000003F0000000003FFFFFF0003F8001FC003F00000FE001F80000000003F00000001FFFFFFF800000FE0007E001FC000000000003F0000000001FFFFFE0003F8001FE007F000007E001F80000000003F00000000FFFFFBFC00000FE000FE003FC000000000003F0000000000FFFFF80003F8000FE007F000007F001F80000000003F000000007FFFF1FC00000FE000FE003F8000000000003F00000000003FFFE00003F8000FF00FE000007F001F80000000003F000000003FFFC0FE00000FE000FC007F0000000000003F000000000007FF8000000000000000000000000000000000000000000000000FFF000000000FE000FC007F0000000000003F000000000000000000000000000000000000000000000000000000000000000000000000000FE000FC00FE0000000000003F000000000000000000000000000000000000000000000000000000000000000000000000000FE001FC00FE0000000000003F000000000000000000000000000000000000000000000000000000000000000000000000000FE001FC00FC0000000000003F000000000000000000000000000000000000000000000000000000000000000000000000000FE001F800FC0000000000003F000000000000000000000000000000000000000000000000000000000000000000000000000FE001F800FC0000000000003F000000000000000000000000000000000000000000000000000000000000000000000000000FE001F800FC0000000000003F000000000000000000000000000000000000000000000000000000000000000000000000000FE001F800FC0000000000003F000000000000000000000000000000000000000000000000000000000000000000000000000FE001F800FC0000000000003F000000000000000000000000000000000000000000000000000000000000000000000000000FE001F800FC0000000000003F000000000000000000000000000000000000000000000000000000000000000000000000000FE001F800FC0000000000003F000000000000000000000000000000000000000000000000000000000000000000000000000FE001F800FC0000000000003F000000000000000000000000000000000000000000000000000000000000000000000000000FE001FC00FC0000000000003F000000000000000000000000000000000000000000000000000000000000000000000000000FE001FC00FE0000000000003F000000000000000000000000000000000000000000000000000000000000000000000000000FE000FC00FE0000000000003F000000000001FC0000000000000000000000000000000000000000000000000000000000000FE000FC007E0000000000003F00000000001FFFC00007E00003F000FC00000FFFFFFFC00FC00007E000FFFFC000007FFFFFCFE000FC007F0000000000003F00000000007FFFF00007E00003F000FE00000FFFFFFFC00FC00007E000FFFFFC00007FFFFFCFE000FC007F0000000000003F0000000001FFFFFC0007E00003F000FE00000FFFFFFFC00FC00007E000FFFFFE00007FFFFFCFE000FE003F8000000000003F0000000003FFFFFE0007E00003F000FE00000FFFFFFFC00FC00007E000FFFFFF80007FFFFFCFE0007E003FC000000000003F0000000007FFFFFF0007E00003F000FE00000FFFFFFFC00FC00007E000FFFFFFC0007FFFFFCFE0007E001FE000000000003F000000000FFF8FFF8007E00003F000FE00000FFFFFFFC00FC00007E000FFFFFFC0007FFFFFCFE0007F000FF000000000003F000000001FF800FFC007E00003F000FE00000001FC00000FC00007E000FC007FE0007E00000FE0003F000FF800000000003F000000003FE0003FC007E00003F000FE00000001FC00000FC00007E000FC001FE0007E00000FE0003F8007FE00000000003F000000007FC0001F8007E00003F000FE00000001FC00000FC00007E000FC000FF0007E00000FE0003F8003FF00000000003F000000007F80000E0007E00003F000FE00000001FC00000FC00007E000FC0007F0007E00000FE0001FC001FFE0000000003F00000000FF0000000007E00003F000FE00000001FC00000FC00007E000FC0007F0007E00000FE0001FC000FFFE000010003F00000000FE0000000007E00003F000FE00000001FC00000FC00007E000FC0007F0007E00000FE0000FE0003FFFFFFFF8003F00000001FE0000000007E00003F000FE00000001FC00000FC00007E000FC0007F0007E00000FE0000FF0001FFFFFFFF8003F00000001FC0000000007E00003F000FE00000001FC00000FC00007E000FC0007F0007E00000FE00007F80007FFFFFFF8003F00000001FC0000000007E00003F000FE00000001FC00000FC00007E000FC0007F0007E00000FE00003FC0001FFFFFFF8003F00000001F80000000007E00003F000FE00000001FC00000FC00007E000FC000FE0007FFFFE0FE00003FE00007FFFFFF8003F00000001F80000000007E00003F000FE00000001FC00000FC00007E000FC001FE0007FFFFF0FE00001FF000007FFFFF0003F00000003F80000000007E00003F000FE00000001FC00000FC00007E000FE00FFC0007FFFFF0FE00000FF800000000000003F00000003F80000000007E00003F000FE00000001FC00000FC00007E000FFFFFFC0007FFFFE0FE000007FC00000000000003F00000003F80000000007E00003F000FE00000001FC00000FC00007E000FFFFFF80007FFFFE0FE000003FF00000000000003F00000001F80000000007E00003F000FE00000001FC00000FC00007E000FFFFFF00007FFFFE0FE000001FFC0000000000003F00000001F80000000007E00003F000FE00000001FC00000FC00007E000FFFFFC00007E00000FE000000FFF0000000000003F00000001F80000000007E00003F000FE00000001FC00000FC00007E000FFFFF800007E00000FE0000007FFC000000000003F00000001FC0000000007E00003F000FE00000001FC00000FC00007E000FFFFF800007E00000FE0000001FFFC00000000003F00000001FC0000000007E00003F000FE00000001FC00000FC00007E000FC01FC00007E00000FE0000000FFFFE0000078003F00000000FE0000000007E00003F000FE00000001FC00000FC00007E000FC01FC00007E00000FE00000003FFFFFFFFFF8003F00000000FE0000000007E00007F000FE00000001FC00000FE0000FE000FC00FE00007E00000FE00000000FFFFFFFFFF8003F00000000FF0000000007F00007F000FE00000001FC00000FE0000FE000FC00FE00007E00000FE000000003FFFFFFFFF8003F000000007F80000F0007F0000FE000FE00000001FC00000FF0001FC000FC007F00007E00000FE0000000007FFFFFFFF8003F000000003FC0001F8003F8000FE000FE00000001FC000007F0001FC000FC007F80007E00000FE0000000000FFFFFFFF8003F000000003FF0003FE003FC001FE000FE00000001FC000007F8003FC000FC003F80007E00000FE000000000003FFFFFF0003F000000001FFC00FFC001FF007FC000FE00000001FC000003FE00FF8000FC003FC0007F00000FE0000000000000000000003F000000000FFFCFFF8001FFE3FFC000FFFFFFC001FC000003FFCFFF8000FC001FC0007FFFFFEFE0000000000000000000003F0000000007FFFFFF0000FFFFFF8000FFFFFFC001FC000001FFFFFF0000FC000FE0007FFFFFEFE0000000000000000000003F0000000003FFFFFE00007FFFFF0000FFFFFFC001FC000000FFFFFE0000FC000FF0007FFFFFEFE0000000000000000000003F0000000000FFFFFC00003FFFFE0000FFFFFFC001FC0000007FFFFC0000FC0007F0007FFFFFEFE0000000000000000000003F00000000007FFFF000000FFFF80000FFFFFFC001FC0000001FFFF00000FC0007F8007FFFFFEFE0000000000000000000003F00000000000FFFC0000003FFE000007FFFFFC000F800000007FFC00000FC0003F8007FFFFFCFE0000000000000000000003F000000000000FC000000007E000000000000000000000000007C00000000000000000000000FE0000000000000000000003F000000000000000000000000000000000000000000000000000000000000000000000000000FE0000000000000000000003F000000000000000000000000000000000000000000000000000000000000000000000000000FE0000000000000000000003F000000000000000000000000000000000000000000000000000000000000000000000000000FE0000000000000000000003F000000000000000000000000000000000000000000000000000000000000000000000000000FE0000000000000000000003F000000000000000000000000000000000000000000000000000000000000000000000000000FE0000000000000000000003F000000000000000000000000000000000000000000000000000000000000000000000000000FFFFFFFFFFFFFFFFFFFFFFFFF000000000000000000000000000000000000000000000000000000000000000000000000000FFFFFFFFFFFFFFFFFFFFFFFFF000000000000000000000000000000000000000000000000000000000000000000000000000FFFFFFFFFFFFFFFFFFFFFFFFF000000000000000000000000000000000000000000000000000000000000000000000000000FFFFFFFFFFFFFFFFFFFFFFFFF000000000000000000000000000000000000000000000000000000000000000000000000000FFFFFFFFFFFFFFFFFFFFFFFFF000000000000000000000000000000000000000000000000000000000000000000000000000FFFFFFFFFFFFFFFFFFFFFFFFF000000000000000000000000000000000000000000000000000000000000000000000000000';

/** Instagram icon (24x24 bitmap) */
const INSTAGRAM_ICON = '^GFA,72,72,3,0000000FFFF01FFFF83C003C70000E7000EE607EE660FFE661E7866381C66381C66300C66300C66381C66381C661E78660FF06607E0670000E70000E3C003C1FFFF80FFFF0000000';

/** Globe icon (24x24 bitmap) */
const GLOBE_ICON = '^GFA,72,72,3,00000000FF0003FFC007FFE00F7EF01CE73838E71C38C31C71C38E71C38E71C38E7FFFFE7FFFFE71C38E71C38E71C38E38C31C38E71C1CE7380F7EF007FFE003FFC000FF00000000';

/**
 * Generate ZPL code for a dispatch pallet label
 *
 * Label layout (4" x 6" at 203 DPI = 812 x 1218 dots):
 * - Top: C&C logo (left) + QR code (right)
 * - Distributor name (large), batch number, date, case count
 * - PALLET ___ OF ___ field for hand-writing
 * - Order numbers list
 * - Notes
 * - Instagram + website footer
 * - Summary line
 */
const generateDispatchLabelZpl = (data: DispatchLabelData) => {
  const batchNumber = escapeZpl(data.batchNumber);
  const distributorName = escapeZpl(truncate(data.distributorName, 28));
  const dispatchDate = formatDate(data.dispatchedAt);
  const notesText = data.notes ? escapeZpl(truncate(data.notes, 50)) : '';

  // Build order number lines (show up to 5 orders, 50px spacing)
  const displayOrders = data.orderNumbers.slice(0, 5);
  const orderLines = displayOrders
    .map((orderNum, i) => {
      const yPos = 790 + i * 50;
      return `^FO70,${yPos}
^A0N,34,34
^FD${escapeZpl(orderNum)}^FS`;
    })
    .join('\n');

  const moreOrdersLine =
    data.orderNumbers.length > 5
      ? `^FO70,${790 + 5 * 50}
^A0N,28,28
^FD+${data.orderNumbers.length - 5} more orders^FS`
      : '';

  const zpl = `^XA
^PW812
^LL1218
^PR3

^FX -- C&C logo (400x119 dots, top-left) --
^FO50,20
${DISPATCH_LOGO_GF}^FS

^FX -- QR code (top-right, mag 5) --
^FO620,25
^BQN,2,5
^FDQA,https://craftculture.xyz^FS

^FX -- Top separator (shortened to avoid QR) --
^FO30,160
^GB570,3,3^FS

^FX -- TO: label --
^FO50,190
^A0N,40,40
^FDTO:^FS

^FX -- Distributor name (large) --
^FO50,245
^A0N,64,64
^FD${distributorName}^FS

^FX -- Separator --
^FO30,335
^GB752,3,3^FS

^FX -- Batch number --
^FO50,365
^A0N,48,48
^FD${batchNumber}^FS

^FX -- Date --
^FO50,430
^A0N,36,36
^FDDate: ${dispatchDate}^FS

^FX -- Total cases (large, right side) --
^FO500,365
^A0N,110,110
^FD${data.totalCases}^FS

^FO500,485
^A0N,34,34
^FDCASES^FS

^FX -- Separator --
^FO30,540
^GB752,3,3^FS

^FX -- Pallet blank (hand-write) --
^FO50,580
^A0N,70,70
^FDPALLET _____ OF _____^FS

^FX -- Separator --
^FO30,680
^GB752,3,3^FS

^FX -- Orders header --
^FO50,715
^A0N,40,40
^FDORDERS (${data.orderNumbers.length})^FS

^FO50,765
^GB712,1,1^FS

^FX -- Order numbers list --
${orderLines}

${moreOrdersLine}

^FX -- Separator --
^FO30,950
^GB752,1,1^FS

${notesText ? `^FX -- Notes --
^FO50,980
^A0N,34,34
^FDNotes: ${notesText}^FS
` : ''}
^FX -- Footer separator --
^FO30,1050
^GB752,2,2^FS

^FX -- Instagram icon + handle --
^FO50,1080
${INSTAGRAM_ICON}^FS
^FO85,1083
^A0N,22,22
^FD@wine.uae^FS

^FX -- Globe icon + website --
^FO300,1080
${GLOBE_ICON}^FS
^FO335,1083
^A0N,22,22
^FDcraftculture.xyz^FS

^FX -- Bottom separator --
^FO30,1130
^GB752,2,2^FS

^FX -- Summary footer --
^FO50,1155
^A0N,22,22
^FD${batchNumber} | ${dispatchDate} | ${data.totalCases} cases^FS

^XZ`;

  return zpl;
};

export default generateDispatchLabelZpl;
