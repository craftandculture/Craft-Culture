# Craft & Culture - Architecture Overview

This document describes the technical architecture of the Craft & Culture platform.

## System Architecture

```
                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                    â”‚            USERS                     â”‚
                                    â”‚  B2B Partners â”‚ B2C â”‚ Private Clientsâ”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                     â”‚
                                                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                      VERCEL                                             â”‚
â”‚                              craftculture.xyz                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚   â”‚         NEXT.JS APP              â”‚    â”‚      SERVERLESS FUNCTIONS        â”‚         â”‚
â”‚   â”‚         (Frontend)               â”‚    â”‚          (Backend)               â”‚         â”‚
â”‚   â”‚                                  â”‚    â”‚                                  â”‚         â”‚
â”‚   â”‚  â€¢ React 19 components           â”‚â—„â”€â”€â–ºâ”‚  â€¢ tRPC API routes               â”‚         â”‚
â”‚   â”‚  â€¢ App Router (routes/)          â”‚    â”‚  â€¢ Better Auth (magic links)     â”‚         â”‚
â”‚   â”‚  â€¢ Tailwind CSS 4                â”‚    â”‚  â€¢ File uploads                  â”‚         â”‚
â”‚   â”‚  â€¢ Client-side state             â”‚    â”‚  â€¢ Business logic                â”‚         â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                           â”‚                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚                             â”‚
â”‚   â”‚         VERCEL BLOB              â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                             â”‚
â”‚   â”‚        (File Storage)            â”‚                    â”‚                             â”‚
â”‚   â”‚  â€¢ Logos, documents              â”‚                    â”‚                             â”‚
â”‚   â”‚  â€¢ Payment proofs                â”‚                    â”‚                             â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚                             â”‚
â”‚                                                           â”‚                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                            â”‚
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚                                   â”‚                           â”‚
                        â–¼                                   â–¼                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            NEON                  â”‚  â”‚         TRIGGER.DEV          â”‚  â”‚         LOOPS           â”‚
â”‚     (PostgreSQL Database)        â”‚  â”‚      (Background Jobs)       â”‚  â”‚   (Email Service)       â”‚
â”‚                                  â”‚  â”‚                              â”‚  â”‚                         â”‚
â”‚  AWS Frankfurt (eu-central-1)    â”‚  â”‚  â€¢ CultX product sync        â”‚  â”‚  â€¢ Magic link emails    â”‚
â”‚                                  â”‚  â”‚  â€¢ Scheduled tasks           â”‚  â”‚  â€¢ Notifications        â”‚
â”‚  Tables:                         â”‚  â”‚  â€¢ Long-running processes    â”‚  â”‚  â€¢ Admin alerts         â”‚
â”‚  â”œâ”€â”€ users                       â”‚  â”‚                              â”‚  â”‚                         â”‚
â”‚  â”œâ”€â”€ sessions                    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â”œâ”€â”€ partners                    â”‚
â”‚  â”œâ”€â”€ quotes                      â”‚
â”‚  â”œâ”€â”€ quote_line_items            â”‚
â”‚  â”œâ”€â”€ products                    â”‚
â”‚  â”œâ”€â”€ pricing_models              â”‚
â”‚  â”œâ”€â”€ sheets                      â”‚
â”‚  â”œâ”€â”€ private_client_orders       â”‚
â”‚  â”œâ”€â”€ commissions                 â”‚
â”‚  â””â”€â”€ ... (50+ tables)            â”‚
â”‚                                  â”‚
â”‚  Drizzle ORM â—„â”€â”€â”€ Type-safe     â”‚
â”‚                    queries       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â–²
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        GOOGLE SHEETS             â”‚
â”‚     (Pricing Model Source)       â”‚
â”‚                                  â”‚
â”‚  â€¢ Spreadsheet formulas          â”‚
â”‚  â€¢ Downloaded & cached           â”‚
â”‚  â€¢ HyperFormula evaluation       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Tech Stack

| Layer | Technology |
|-------|------------|
| Frontend | Next.js 15, React 19, TypeScript |
| Styling | Tailwind CSS 4, tailwind-variants |
| API | tRPC (type-safe RPC) |
| Database | PostgreSQL via Neon (serverless) |
| ORM | Drizzle ORM |
| Auth | Better Auth (magic links) |
| Email | Loops (transactional) |
| Storage | Vercel Blob |
| Background Jobs | Trigger.dev |
| Hosting | Vercel |

## Data Flow Example

### Partner Creates a Quote

```
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Browser â”‚â”€â”€â”€â–ºâ”‚ Next.js â”‚â”€â”€â”€â–ºâ”‚  tRPC   â”‚â”€â”€â”€â–ºâ”‚ Drizzle â”‚â”€â”€â”€â–ºâ”‚  Neon   â”‚
  â”‚  React  â”‚    â”‚  Route  â”‚    â”‚ Router  â”‚    â”‚   ORM   â”‚    â”‚Postgres â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                             â”‚
       â”‚                             â–¼
       â”‚                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                     â”‚   Pricing   â”‚
       â”‚                     â”‚   Model     â”‚â—„â”€â”€ Google Sheet formulas
       â”‚                     â”‚ Calculation â”‚    evaluated via HyperFormula
       â”‚                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                             â”‚
       â–¼                             â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  Quote  â”‚                â”‚   Loops     â”‚
  â”‚ Preview â”‚                â”‚   Email     â”‚â”€â”€â”€â–º Admin notification
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Deployment Pipeline

```
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  Push   â”‚â”€â”€â”€â–ºâ”‚ GitHub  â”‚â”€â”€â”€â–ºâ”‚ Vercel  â”‚â”€â”€â”€â–ºâ”‚ Build   â”‚â”€â”€â”€â–ºâ”‚  Live   â”‚
  â”‚ to main â”‚    â”‚  main   â”‚    â”‚ Webhook â”‚    â”‚ ~2 min  â”‚    â”‚   ğŸš€    â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
               â”‚  Semantic   â”‚
               â”‚  Release    â”‚â”€â”€â”€â–º v1.71.0, v1.72.0, etc.
               â”‚  (Tagging)  â”‚
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Key Directories

```
apps/web/src/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ (routes)/          # Next.js App Router pages
â”‚   â”œâ”€â”€ _admin/            # Admin features
â”‚   â”œâ”€â”€ _auth/             # Authentication
â”‚   â”œâ”€â”€ _quotes/           # Quote management
â”‚   â”œâ”€â”€ _partners/         # Partner management
â”‚   â”œâ”€â”€ _products/         # Product catalog
â”‚   â”œâ”€â”€ _pricingModels/    # Pricing engine
â”‚   â”œâ”€â”€ _pricingCalculator/# Internal pricing tool
â”‚   â”œâ”€â”€ _privateClientOrders/ # PCO system
â”‚   â””â”€â”€ _ui/               # Shared UI components
â”œâ”€â”€ database/
â”‚   â”œâ”€â”€ schema.ts          # Drizzle schema (all tables)
â”‚   â””â”€â”€ client.ts          # Database connection
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ better-auth/       # Auth configuration
â”‚   â”œâ”€â”€ trpc/              # tRPC setup
â”‚   â””â”€â”€ loops/             # Email client
â””â”€â”€ trpc-router.ts         # Main API router
```

## Environment Variables

Stored in Vercel, injected at build/runtime:

| Variable | Purpose |
|----------|---------|
| `DATABASE_URL` | Neon PostgreSQL connection |
| `BETTER_AUTH_SECRET` | Auth encryption key |
| `LOOPS_API_KEY` | Email service |
| `BLOB_READ_WRITE_TOKEN` | Vercel Blob storage |
| `TRIGGER_SECRET_KEY` | Background jobs |
| `GOOGLE_CLIENT_*` | Google Sheets OAuth |

## External Integrations

| Service | Purpose | API |
|---------|---------|-----|
| CultX | Wine trading platform | REST API (product sync) |
| Google Sheets | Pricing formulas | Sheets API v4 |
| Loops | Transactional email | REST API |
| Neon | Serverless Postgres | PostgreSQL protocol |
